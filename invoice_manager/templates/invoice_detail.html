{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">Invoice {{ invoice.invoice_number }}</h2>
    <div class="text-muted small">
      {{ invoice.customer.name if invoice.customer else "No customer" }}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('edit_invoice', invoice_id=invoice.id) }}" class="btn btn-outline-light btn-sm">
      Edit invoice
    </a>
    <a href="{{ url_for('list_invoices') }}" class="btn btn-secondary btn-sm">
      Back to invoices
    </a>
    <a href="{{ url_for('invoice_print', invoice_id=invoice.id) }}"
   class="btn btn-outline-light btn-sm" target="_blank">
  Print / PDF
</a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card-dark p-3 p-md-4 mb-3">
      <div class="row mb-3">
        <div class="col-md-6">
          <h6 class="text-muted mb-1">Customer</h6>
          {% if invoice.customer %}
            <div class="fw-semibold">{{ invoice.customer.name }}</div>
            {% if invoice.customer.email %}
              <div class="small text-muted">{{ invoice.customer.email }}</div>
            {% endif %}
            {% if invoice.customer.address_line1 %}
              <div class="small text-muted">
                {{ invoice.customer.address_line1 }}<br>
                {% if invoice.customer.address_line2 %}
                  {{ invoice.customer.address_line2 }}<br>
                {% endif %}
                {% if invoice.customer.city %}
                  {{ invoice.customer.city }}
                {% endif %}
                {% if invoice.customer.postcode %}
                  {{ " " ~ invoice.customer.postcode }}
                {% endif %}
                {% if invoice.customer.country %}
                  <br>{{ invoice.customer.country }}
                {% endif %}
              </div>
            {% endif %}
          {% else %}
            <div class="text-muted small">No customer information.</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <h6 class="text-muted mb-1">Invoice details</h6>
          <div class="small">
            <div class="d-flex justify-content-between">
              <span>Status</span>
              <span class="badge
                  {% if invoice.status == 'paid' %}bg-success
                  {% elif invoice.status == 'overdue' %}bg-danger
                  {% elif invoice.status == 'draft' %}bg-secondary
                  {% else %}bg-primary{% endif %}">
                {{ invoice.status|capitalize }}
              </span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Issue date</span>
              <span>{{ invoice.issue_date }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Due date</span>
              <span>{{ invoice.due_date }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Tax rate</span>
              <span>
                {% if invoice.tax_rate is not none %}
                  {{ "%.2f"|format(invoice.tax_rate) }}%
                {% else %}
                  â€“
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </div>

      <h6 class="mb-2">Line items</h6>

      {% if invoice.items %}
        <div class="table-responsive">
          <table class="table table-dark align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 25%;">Product</th>
                <th style="width: 35%;">Description</th>
                <th class="text-end" style="width: 10%;">Qty</th>
                <th class="text-end" style="width: 15%;">Unit price</th>
                <th class="text-end" style="width: 15%;">Line total</th>
              </tr>
            </thead>
            <tbody>
            {% for item in invoice.items %}
              <tr>
                <td>
                  {% if item.product %}
                    {{ item.product.name }}
                  {% else %}
                    Manual
                  {% endif %}
                </td>
                <td>{{ item.description }}</td>
                <td class="text-end">{{ "%.2f"|format(item.quantity) }}</td>
                <td class="text-end">{{ "%.2f"|format(item.unit_price) }}</td>
                <td class="text-end">{{ "%.2f"|format(item.line_total) }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted small">
          No line items on this invoice.
        </div>
      {% endif %}

      {% if invoice.notes %}
        <div class="mt-3">
          <h6 class="text-muted mb-1">Notes</h6>
          <p class="small mb-0">{{ invoice.notes }}</p>
        </div>
      {% endif %}
    </div>

    <!-- Payments -->
    <div class="card-dark p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Payments</h6>
      </div>

      {% if invoice.payments %}
        <div class="table-responsive mb-3">
          <table class="table table-dark align-middle mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Method</th>
                <th>Reference</th>
                <th class="text-end">Amount</th>
              </tr>
            </thead>
            <tbody>
            {% for p in invoice.payments %}
              <tr>
                <td>{{ p.payment_date }}</td>
                <td>{{ p.method or "-" }}</td>
                <td>{{ p.external_reference or "-" }}</td>
                <td class="text-end">{{ "%.2f"|format(p.amount) }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted small mb-2">
          No payments recorded yet.
        </div>
      {% endif %}

      <form method="post" action="{{ url_for('add_payment', invoice_id=invoice.id) }}" class="row g-2 g-md-3 align-items-end">
        <div class="col-6 col-md-3">
          <label class="form-label">Amount</label>
          <input type="number"
                 step="0.01"
                 min="0"
                 name="amount"
                 class="form-control"
                 required>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Payment date</label>
          <input type="date"
                 name="payment_date"
                 class="form-control"
                 required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Method</label>
          <input type="text"
                 name="method"
                 class="form-control"
                 placeholder="Bank, card...">
        </div>
        <div class="col-md-3">
          <label class="form-label">Reference</label>
          <input type="text"
                 name="external_reference"
                 class="form-control"
                 placeholder="Txn ID, ref...">
        </div>
        <div class="col-12 col-md-1 d-grid">
          <button type="submit" class="btn btn-primary">
            Add
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-dark p-3 p-md-4">
      <h5 class="mb-3">Totals</h5>
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted">Subtotal</span>
        <span>{{ "%.2f"|format(invoice.subtotal_amount) }}</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted">
          VAT
          {% if invoice.tax_rate is not none %}
            ({{ "%.2f"|format(invoice.tax_rate) }}%)
          {% endif %}
        </span>
        <span>{{ "%.2f"|format(invoice.tax_amount) }}</span>
      </div>
      <hr class="my-2" style="border-color: rgba(255,255,255,0.1);">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <span class="fw-semibold">Total</span>
        <span class="fw-bold fs-5">{{ "%.2f"|format(invoice.total_amount) }}</span>
      </div>
      <div class="d-flex justify-content-between">
        <span class="text-muted small">Balance due</span>
        <span class="small">
          {{ "%.2f"|format(invoice.balance_due) }}
        </span>
      </div>
    </div>
  </div>
</div>
{% endblock %}
