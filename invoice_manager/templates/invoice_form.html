{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">
      {% if invoice %}Edit Invoice{% else %}New Invoice{% endif %}
    </h2>
    <div class="text-muted small">
      Choose a customer, add product lines, and review totals in real time.
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card-dark p-3 p-md-4 mb-3">
      <form method="post" id="invoice-form">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Customer</label>
            <select name="customer_id" class="form-select" id="customer-select" required>
              <option value="">Select customer...</option>
              {% for c in customers %}
                {% set effective_tax = (c.tax_rate if not c.use_default_tax and c.tax_rate is not none else settings.default_tax_rate) %}
                <option value="{{ c.id }}"
                        data-tax-rate="{{ effective_tax or 0 }}"
                        {% if invoice and invoice.customer_id == c.id %}selected{% endif %}>
                  {{ c.name }}{% if c.email %} â€“ {{ c.email }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Issue date</label>
            <input type="date"
                   name="issue_date"
                   class="form-control"
                   value="{% if invoice and invoice.issue_date %}{{ invoice.issue_date.strftime('%Y-%m-%d') }}{% endif %}"
                   required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Due date</label>
            <input type="date"
                   name="due_date"
                   class="form-control"
                   value="{% if invoice and invoice.due_date %}{{ invoice.due_date.strftime('%Y-%m-%d') }}{% endif %}">
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
              {% set current_status = invoice.status if invoice else 'draft' %}
              {% for s in ['draft','sent','paid','partial','overdue','cancelled'] %}
                <option value="{{ s }}" {% if current_status == s %}selected{% endif %}>
                  {{ s|capitalize }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="2">{{ invoice.notes if invoice else '' }}</textarea>
          </div>
        </div>

        <input type="hidden"
               id="tax-rate-input"
               value="{{ (invoice.tax_rate if invoice and invoice.tax_rate is not none else settings.default_tax_rate) or 0 }}">

        <div class="mb-2 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Line items</h5>
          <button type="button" class="btn btn-sm btn-outline-light" id="add-line-btn">
            <i class="fa-solid fa-plus me-1"></i> Add line
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-dark align-middle mb-0" id="items-table">
            <thead>
              <tr>
                <th style="width: 25%;">Product/Service</th>
                <th style="width: 30%;">Description</th>
                <th style="width: 12%;">Qty</th>
                <th style="width: 15%;">Unit price</th>
                <th style="width: 15%;">Line total</th>
                <th style="width: 3%;"></th>
              </tr>
            </thead>
            <tbody>
            {% if invoice and invoice.items %}
              {% for item in invoice.items %}
                <tr class="item-row">
                  <td>
                    <select class="form-select product-select" name="item_product_id">
                      <option value="">Manual...</option>
                      {% for p in products %}
                        <option value="{{ p.id }}"
                                data-description="{{ (p.description or '')|e }}"
                                data-price="{{ p.unit_price or 0 }}"
                                {% if item.product_id == p.id %}selected{% endif %}>
                          {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input type="text"
                           name="item_description"
                           class="form-control"
                           value="{{ item.description }}">
                  </td>
                  <td>
                    <input type="number"
                           step="0.01"
                           min="0"
                           name="item.qty"
                           class="form-control text-end"
                           value="{{ item.qty }}">
                  </td>
                  <td>
                    <input type="number"
                           step="0.01"
                           min="0"
                           name="item_unit_price"
                           class="form-control text-end"
                           value="{{ '%.2f'|format(item.unit_price) }}">
                  </td>
                  <td class="text-end">
                    <span class="line-total">{{ '%.2f'|format(item.line_total or 0) }}</span>
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">
                      <i class="fa-solid fa-xmark"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr class="item-row">
                <td>
                  <select class="form-select product-select" name="item_product_id">
                    <option value="">Manual...</option>
                    {% for p in products %}
                      <option value="{{ p.id }}"
                              data-description="{{ (p.description or '')|e }}"
                              data-price="{{ p.unit_price or 0 }}">
                        {{ p.name }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input type="text" name="item_description" class="form-control">
                </td>
                <td>
                  <input type="number"
                         step="0.01"
                         min="0"
                         name="item.qty"
                         class="form-control text-end"
                         value="1">
                </td>
                <td>
                  <input type="number"
                         step="0.01"
                         min="0"
                         name="item_unit_price"
                         class="form-control text-end"
                         value="0.00">
                </td>
                <td class="text-end">
                  <span class="line-total">0.00</span>
                </td>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>

        <div class="mt-3 d-flex justify-content-between">
          <a href="{{ url_for('list_invoices') }}" class="btn btn-outline-light">
            Cancel
          </a>
          <button type="submit" class="btn btn-primary">
            Save invoice
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card-dark p-3 p-md-4 mb-3">
      <h5 class="mb-3">Totals</h5>
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted-soft">Subtotal</span>
        <span id="summary-subtotal">0.00</span>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted-soft">
          VAT (<span id="summary-tax-rate">{{ (invoice.tax_rate if invoice and invoice.tax_rate is not none else settings.default_tax_rate) or 0 }}</span>%)
        </span>
        <span id="summary-tax">0.00</span>
      </div>
      <hr class="my-2" style="border-color: rgba(255,255,255,0.1);">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <span class="fw-semibold">Total</span>
        <span class="fw-bold fs-5" id="summary-total">0.00</span>
      </div>
      <div class="text-muted-soft small">
        Totals are indicative based on the current customer tax settings and line items.
      </div>
    </div>

    {# Payment section: ONLY on edit, with date picker #}
    {% if invoice %}
    <div class="card-dark mt-3 p-3 p-md-4">
      <h5 class="mb-3">Payment</h5>

      <div class="mb-3">
        <label class="form-label">Payment amount</label>
        <input type="number"
               step="0.01"
               min="0"
               name="payment_amount"
               class="form-control text-end"
               value="">
        <div class="form-text text-muted-soft">
          Leave blank to keep the current balance.
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Payment date</label>
        <input type="date"
               name="payment_date"
               class="form-control"
               value="{{ invoice.payment_date.strftime('%Y-%m-%d') if invoice and invoice.payment_date else '' }}">
      </div>

      <div class="mb-2">
        <label class="form-label">Mark status</label>
        <select name="payment_status" class="form-select">
          <option value="">Don't change</option>
          <option value="paid">Mark as Paid</option>
          <option value="partial">Mark as Partially Paid</option>
        </select>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  function recalcTotals() {
    let subtotal = 0;
    document.querySelectorAll("#items-table tbody tr.item-row").forEach(row => {
      const qtyInput = row.querySelector('input[name="item.qty"]');
      const priceInput = row.querySelector('input[name="item_unit_price"]');
      const lineSpan = row.querySelector(".line-total");

      const qty = parseFloat(qtyInput && qtyInput.value || "0") || 0;
      const price = parseFloat(priceInput && priceInput.value || "0") || 0;
      const line = qty * price;
      subtotal += line;

      if (lineSpan) {
        lineSpan.textContent = line.toFixed(2);
      }
    });

    const taxRateInput = document.getElementById("tax-rate-input");
    const taxRateSpan = document.getElementById("summary-tax-rate");
    let taxRate = parseFloat(taxRateInput && taxRateInput.value || "0") || 0;
    const tax = subtotal * taxRate / 100.0;
    const total = subtotal + tax;

    document.getElementById("summary-subtotal").textContent = subtotal.toFixed(2);
    document.getElementById("summary-tax").textContent = tax.toFixed(2);
    document.getElementById("summary-total").textContent = total.toFixed(2);
    if (taxRateSpan) {
      taxRateSpan.textContent = taxRate.toFixed(2).replace(/\.00$/, '');
    }
  }

  function bindRowEvents(row) {
    const qtyInput = row.querySelector('input[name="item.qty"]');
    const priceInput = row.querySelector('input[name="item_unit_price"]');
    const removeBtn = row.querySelector(".remove-line-btn");
    const productSelect = row.querySelector(".product-select");

    [qtyInput, priceInput].forEach(input => {
      if (!input) return;
      input.addEventListener("input", recalcTotals);
    });

    if (removeBtn) {
      removeBtn.addEventListener("click", () => {
        const rows = document.querySelectorAll("#items-table tbody tr.item-row");
        if (rows.length > 1) {
          row.remove();
          recalcTotals();
        }
      });
    }

    if (productSelect) {
      productSelect.addEventListener("change", () => {
        const selected = productSelect.options[productSelect.selectedIndex];
        const descInput = row.querySelector('input[name="item_description"]');
        const priceInput = row.querySelector('input[name="item_unit_price"]');
        const desc = selected.getAttribute("data-description") || "";
        const price = selected.getAttribute("data-price") || "";

        if (desc && descInput && descInput.value.trim() === "") {
          descInput.value = desc;
        }
        if (price && priceInput) {
          priceInput.value = parseFloat(price).toFixed(2);
        }
        recalcTotals();
      });
    }
  }

  document.querySelectorAll("#items-table tbody tr.item-row").forEach(bindRowEvents);

  document.getElementById("add-line-btn").addEventListener("click", () => {
    const tbody = document.querySelector("#items-table tbody");
    const row = document.createElement("tr");
    row.classList.add("item-row");
    row.innerHTML = `
      <td>
        <select class="form-select product-select" name="item_product_id">
          <option value="">Manual...</option>
          {% for p in products %}
          <option value="{{ p.id }}"
                  data-description="{{ (p.description or '')|e }}"
                  data-price="{{ p.unit_price or 0 }}">
            {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input type="text" name="item_description" class="form-control">
      </td>
      <td>
        <input type="number" step="0.01" min="0" name="item.qty"
               class="form-control text-end" value="1">
      </td>
      <td>
        <input type="number" step="0.01" min="0" name="item_unit_price"
               class="form-control text-end" value="0.00">
      </td>
      <td class="text-end">
        <span class="line-total">0.00</span>
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
    bindRowEvents(row);
    recalcTotals();
  });

  const customerSelect = document.getElementById("customer-select");
  const taxRateInput = document.getElementById("tax-rate-input");
  if (customerSelect && taxRateInput) {
    customerSelect.addEventListener("change", () => {
      const opt = customerSelect.options[customerSelect.selectedIndex];
      const rate = opt.getAttribute("data-tax-rate") || "0";
      taxRateInput.value = rate;
      recalcTotals();
    });
  }

  recalcTotals();
})();
</script>
{% endblock %}
