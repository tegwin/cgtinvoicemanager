{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">üîë API Keys</h1>
  <p class="page-subtitle">
    Manage API keys for programmatic access. New keys are only shown in full once.
  </p>
</div>

{% if session.get('new_api_key') %}
<div class="panel mb-3" style="border: 2px solid var(--accent-green); background: rgba(16, 185, 129, 0.08);">
  <h3 style="color: var(--accent-green); margin-top: 0;">
    ‚úÖ API Key Created: {{ session.pop('new_api_key_name', 'New Key') }}
  </h3>
  <p class="text-muted" style="margin-bottom: 0.9rem;">
    <strong>‚ö†Ô∏è Copy this key now!</strong> It will not be shown again once you leave or refresh this page.
  </p>
  <div style="display: flex; align-items: center; gap: 0.8rem; margin-top: 0.6rem; flex-wrap: wrap;">
    <div style="flex: 1; padding: 0.7rem 0.9rem; font-family: monospace; font-size: 0.95rem; border-radius: 10px; background: rgba(15,23,42,0.95); border: 1px solid rgba(55,65,81,0.9);">
      <code id="new-api-key">{{ session.pop('new_api_key') }}</code>
    </div>
  </div>
</div>
{% endif %}

<div class="panel">
  <div class="panel-header">
    <div>
      <div class="panel-title">Existing API Keys</div>
      <div class="panel-subtitle">
        Keys are masked for security. Create a new key for each external system.
      </div>
    </div>
    <div>
      <a href="{{ url_for('api_keys_new') }}" class="btn btn-primary btn-sm">
        ‚ûï New API Key
      </a>
    </div>
  </div>

  {% if api_keys %}
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Key (masked)</th>
        <th>Status</th>
        <th>Created</th>
        <th>Last used</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for k in api_keys %}
        {% if k.key %}
          {% set masked = '****-****-' ~ k.key[-4:] %}
        {% else %}
          {% set masked = 'N/A' %}
        {% endif %}
        <tr>
          <td>{{ k.name }}</td>
          <td><code>{{ masked }}</code></td>
          <td>
            {% if k.active %}
              <span style="color: var(--accent-green); font-size: 0.8rem;">‚óè Active</span>
            {% else %}
              <span style="color: var(--text-muted); font-size: 0.8rem;">‚óè Inactive</span>
            {% endif %}
          </td>
          <td>{{ k.created_at.strftime('%Y-%m-%d %H:%M') if k.created_at else '-' }}</td>
          <td>{{ k.last_used_at.strftime('%Y-%m-%d %H:%M') if k.last_used_at else 'Never' }}</td>
          <td>
            <form method="post" action="{{ url_for('api_keys_toggle', key_id=k.id) }}" style="display:inline;">
              <button class="btn btn-secondary btn-sm" type="submit">
                {% if k.active %}Disable{% else %}Enable{% endif %}
              </button>
            </form>
            <form method="post" action="{{ url_for('api_keys_delete', key_id=k.id) }}" style="display:inline;"
                  onsubmit="return confirm('Delete this API key? This cannot be undone.');">
              <button class="btn btn-sm" type="submit" style="background: #7f1d1d; border: 1px solid #b91c1c;">
                Delete
              </button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p class="text-muted" style="margin-top: 0.6rem;">
      No API keys yet. Click <strong>New API Key</strong> to create one.
    </p>
  {% endif %}
</div>

<div style="margin-top: 1rem;">
  <a href="{{ url_for('settings_view') }}" class="btn btn-secondary btn-sm">‚Üê Back to Settings</a>
  <a href="{{ url_for('api_docs') }}" class="btn btn-secondary btn-sm">üìö View API Docs</a>
</div>
{% endblock %}
