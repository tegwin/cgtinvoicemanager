{% extends "base.html" %}

{% block content %}
<div class="mb-3">
  <h1 class="h3 mb-0">API Keys</h1>
  <div class="section-subtitle">
    Manage API access for integrations and automations.
  </div>
</div>

{% if new_key_value %}
<div class="alert alert-soft mb-4">
  <div class="d-flex align-items-start">
    <div class="me-2 mt-1">
      <i class="fa-solid fa-key"></i>
    </div>
    <div>
      <div class="fw-semibold mb-1">
        New API key generated
      </div>
      <div class="small text-muted-soft">
        This key will only be shown once. Copy it now and store it securely.
      </div>
      <div class="mt-2">
        <code class="small">{{ new_key_value }}</code>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-4">
  <!-- Create new key -->
  <div class="col-lg-4">
    <div class="card-dark-soft p-3 p-md-4 h-100">
      <h2 class="section-title mb-1">Create new API key</h2>
      <p class="section-subtitle mb-3">
        Give the key a name so you know which integration it belongs to.
      </p>

      <form method="post" action="{{ url_for('api_keys_new') }}">
        <div class="mb-3">
          <label class="form-label">Key name</label>
          <input type="text"
                 name="name"
                 class="form-control"
                 placeholder="e.g. n8n, Zapier, backend sync"
                 required>
        </div>

        <div class="mb-3">
          <label class="form-label d-block">Permissions</label>
          <div class="small text-muted-soft">
            For now, keys always have full read &amp; write access.
          </div>
          <div class="mt-2">
            <span class="badge badge-pill badge-soft-blue me-1">read</span>
            <span class="badge badge-pill badge-soft-blue">write</span>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">
          <i class="fa-solid fa-key me-2"></i> Generate API key
        </button>
      </form>
    </div>
  </div>

  <!-- Existing keys -->
  <div class="col-lg-8">
    <div class="card-dark p-3 p-md-4 h-100">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="section-title mb-0">Your API keys</div>
          <div class="section-subtitle">
            Each key has full read/write access to the JSON API.
          </div>
        </div>
      </div>

      {% if api_keys %}
      <div class="table-responsive">
        <table class="table table-dark align-middle mb-0">
          <thead>
          <tr>
            <th style="width: 20%;">Name</th>
            <th style="width: 23%;">Key ID</th>
            <th style="width: 18%;">Permissions</th>
            <th style="width: 14%;">Created</th>
            <th style="width: 14%;">Last used</th>
            <th style="width: 11%;">Status</th>
            <th class="text-end" style="width: 10%;">Actions</th>
          </tr>
          </thead>
          <tbody>
          {% for key in api_keys %}
          <tr>
            <td class="fw-semibold">
              {{ key.name }}
            </td>
            <td class="text-muted-soft small">
              {{ key.key[:10] }}â€¦
            </td>
            <td>
              <span class="badge badge-pill badge-soft-blue me-1">read</span>
              <span class="badge badge-pill badge-soft-blue">write</span>
            </td>
            <td class="small text-muted-soft">
              {{ key.created_at.date() if key.created_at else "-" }}
            </td>
            <td class="small text-muted-soft">
              {{ key.last_used_at.date() if key.last_used_at else "Never" }}
            </td>
            <td>
              {% if key.active %}
              <span class="badge badge-pill badge-soft-green">Active</span>
              {% else %}
              <span class="badge badge-pill badge-soft-red">Revoked</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="d-inline-flex gap-1">
                <form method="post"
                      action="{{ url_for('api_keys_toggle', key_id=key.id) }}"
                      class="d-inline">
                  <button type="submit" class="btn btn-sm btn-outline-light">
                    {{ "Revoke" if key.active else "Activate" }}
                  </button>
                </form>
                <form method="post"
                      action="{{ url_for('api_keys_delete', key_id=key.id) }}"
                      class="d-inline"
                      onsubmit="return confirm('Delete this API key? This cannot be undone.');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    Delete
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-muted-soft small">
        No API keys yet. Create one on the left to start using the JSON API.
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
