{% extends "base.html" %}

{% block content %}
<div class="page-header mb-4 d-flex justify-content-between align-items-center">
  <div>
    <h2 class="mb-1">API Keys</h2>
    <p class="text-muted mb-0">Manage API keys for external access to your invoices.</p>
  </div>
  <a href="{{ url_for('api_keys_new') }}" class="btn btn-primary">
    <i class="fa-solid fa-key me-2"></i>Create New API Key
  </a>
</div>

<div class="card-dark p-3 p-md-4 mb-4">
  <h5 class="mb-3">Your API Keys</h5>

  {% if api_keys %}
  <div class="table-responsive">
    <table class="table table-dark align-middle mb-0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Key ID</th>
          <th>Permissions</th>
          <th>Created</th>
          <th>Last used</th>
          <th>Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for key in api_keys %}
        <tr>
          <td class="fw-semibold">{{ key.name }}</td>
          <td class="font-mono small">
            {{ key.key[:12] }}…
          </td>
          <td>
            {% if key.can_read %}
              <span class="badge-pill badge-pill-blue me-1">read</span>
            {% endif %}
            {% if key.can_write %}
              <span class="badge-pill badge-pill-green">write</span>
            {% endif %}
          </td>
          <td>{{ key.created_at.date() if key.created_at else "-" }}</td>
          <td>
            {% if key.last_used_at %}
              {{ key.last_used_at.date() }}
            {% else %}
              <span class="text-muted">Never</span>
            {% endif %}
          </td>
          <td>
            {% if key.active %}
              <span class="badge-pill badge-pill-green-soft">Active</span>
            {% else %}
              <span class="badge-pill badge-pill-grey-soft">Inactive</span>
            {% endif %}
          </td>
          <td class="text-end">
            <form method="post" action="{{ url_for('api_keys_toggle', key_id=key.id) }}" class="d-inline">
              <button type="submit" class="btn btn-sm btn-outline-light me-1">
                {% if key.active %}Revoke{% else %}Activate{% endif %}
              </button>
            </form>
            <form method="post" action="{{ url_for('api_keys_delete', key_id=key.id) }}" class="d-inline"
                  onsubmit="return confirm('Delete this API key? This cannot be undone.');">
              <button type="submit" class="btn btn-sm btn-outline-danger">
                Delete
              </button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-muted mb-0">You haven’t created any API keys yet.</p>
  {% endif %}
</div>

<div class="card-dark p-3 p-md-4">
  <h5 class="mb-3">How to use API keys</h5>
  <p class="text-muted small mb-2">
    Include your API key in the <code class="code-chip">X-API-Key</code> header when calling the API:
  </p>
  <pre class="code-block mb-2"><code>curl -X GET \
  "{{ url_for('api_get_invoice', invoice_id=123, _external=True) }}" \
  -H "X-API-Key: YOUR_KEY_HERE"</code></pre>
  <p class="text-muted small mb-0">
    Keys with only <span class="badge-pill badge-pill-blue">read</span> can call GET endpoints.
    Keys with <span class="badge-pill badge-pill-green">write</span> can create and update invoices or send payment webhooks.
  </p>
</div>
{% endblock %}
