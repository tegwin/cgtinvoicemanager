{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
  <div class="col d-flex align-items-center justify-content-between">
    <div>
      <h1 class="h4 mb-1">API keys</h1>
      <p class="text-muted-soft mb-0">
        Manage access tokens for integrating external systems with your Invoice Manager.
      </p>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Create key -->
  <div class="col-12 col-lg-4">
    <div class="card-dark-soft h-100">
      <div class="card-body p-3 p-lg-4">
        <h2 class="h6 mb-2">Create new key</h2>
        <p class="text-muted-soft small mb-3">
          Choose a descriptive name and permissions. The full key value is shown only once.
        </p>

        <form method="post" action="{{ url_for('api_keys_list') }}">
          <input type="hidden" name="action" value="create">

          <div class="mb-3">
            <label class="form-label small">Key name</label>
            <input type="text"
                   name="name"
                   class="form-control"
                   placeholder="e.g. Production integration"
                   required>
          </div>

          <div class="mb-3">
            <label class="form-label small d-block mb-1">Permissions</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="can_read" id="permRead" checked>
              <label class="form-check-label small" for="permRead">Read</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="can_write" id="permWrite" checked>
              <label class="form-check-label small" for="permWrite">Write</label>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            <i class="fa-solid fa-key me-1"></i> Generate key
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Existing keys -->
  <div class="col-12 col-lg-8">
    <div class="card-dark h-100">
      <div class="card-body p-3 p-lg-4">
        <h2 class="h6 mb-3">Existing keys</h2>

        {% if api_keys %}
          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Key ID</th>
                <th scope="col">Key</th>
                <th scope="col">Permissions</th>
                <th scope="col">Status</th>
                <th scope="col">Created</th>
                <th scope="col">Last used</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
              </thead>
              <tbody>
              {% for key in api_keys %}
                <tr>
                  <td>{{ key.name }}</td>
                  <td class="small text-muted-soft">
                    {{ key.key_id }}
                  </td>
                  <td class="small">
                    {{ key.masked_key }}
                  </td>
                  <td class="small">
                    {% if key.can_read and key.can_write %}
                      Read &amp; write
                    {% elif key.can_read %}
                      Read only
                    {% elif key.can_write %}
                      Write only
                    {% else %}
                      <span class="text-muted-soft">None</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if key.active %}
                      <span class="badge badge-pill badge-soft-green">Active</span>
                    {% else %}
                      <span class="badge badge-pill badge-soft-red">Revoked</span>
                    {% endif %}
                  </td>
                  <td class="small text-muted-soft">
                    {{ key.created_at.strftime("%Y-%m-%d %H:%M") if key.created_at else "â€”" }}
                  </td>
                  <td class="small text-muted-soft">
                    {{ key.last_used_at.strftime("%Y-%m-%d %H:%M") if key.last_used_at else "Never" }}
                  </td>
                  <td class="text-end">
                    {% if key.active %}
                      <form method="post"
                            action="{{ url_for('api_keys_revoke', key_id=key.id) }}"
                            class="d-inline">
                        <button type="submit"
                                class="btn btn-sm btn-outline-light">
                          Revoke
                        </button>
                      </form>
                    {% endif %}
                    <form method="post"
                          action="{{ url_for('api_keys_delete', key_id=key.id) }}"
                          class="d-inline ms-1">
                      <button type="submit"
                              class="btn btn-sm btn-outline-light"
                              onclick="return confirm('Delete this API key permanently?');">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted-soft mb-0">No API keys yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
